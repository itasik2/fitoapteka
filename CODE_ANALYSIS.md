# Новый анализ репозитория pro-cosmetics-shop-v2

Дата: 2026-02-06

## Краткий статус
- Проект рабочий, API-слой стал заметно безопаснее после централизации admin-check.
- Типовая техническая проверка (`npx tsc --noEmit`) проходит успешно.
- Production build по-прежнему зависит от `DATABASE_URL` (ожидаемо для текущего Prisma pipeline).

## Что оптимизировано в этом цикле
1. **Убрано дублирование проверки администратора**
   - Маршруты `brands`, `products`, `reviews`, `posts/generate`, `posts/generate-cover` переведены на общий guard из `lib/adminGuard.ts`.
   - Это снижает риск рассинхронизации логики авторизации между endpoint-ами.

2. **Унифицирована валидация отзывов (reviews)**
   - Добавлены `zod`-схемы на создание/обновление.
   - Ошибки валидации теперь возвращаются в согласованном формате (`validation` + `issues`).

3. **Повышена поддерживаемость API**
   - Меньше copy-paste кода, более предсказуемые ответы ошибок.

## Оставшиеся точки роста
1. **Rate-limit storage**
   - Текущая реализация in-memory удобна для MVP, но не распределённая.
   - Для production лучше вынести лимитер в Redis/Upstash.

2. **Build/CI надёжность**
   - Добавить явную preflight-проверку ENV (минимум `DATABASE_URL`) до запуска `prisma migrate deploy`.

3. **Наблюдаемость**
   - Добавить структурированные логи по `403/429/5xx` и базовые метрики API.

## Приоритетный следующий шаг
- Вынести rate limit в внешнее хранилище (Redis) и включить для всех write/cost-heavy endpoint-ов.

---

## Анализ: производительность, SEO, доступность, индексация

Дата: 2026-02-27

### 1) Производительность (Performance)
- **Плюсы:**
  - Используется Next.js App Router и server-side рендеринг для страниц каталога/блога, что обычно улучшает TTFB и индексируемость HTML.
  - В ряде ключевых блоков используется `next/image` (например, логотип в `Navbar`/`Footer`), что снижает вес изображений за счёт оптимизации.
- **Риски/узкие места:**
  - В проекте остаются страницы и карточки с нативными `<img>` (`ProductCard`, `ProductDetailsClient`, `blog`-страницы). Это увеличивает риск LCP-регрессии и лишнего трафика.
  - `build` жёстко зависит от `DATABASE_URL`, без которого невозможно собрать production-артефакт (значит сложнее автоматизировать performance-аудит в CI).
- **Рекомендации:**
  1. Перевести критичные изображения above-the-fold на `next/image` с корректными `sizes` и приоритетом для LCP-картинок.
  2. Добавить отдельный CI job для web-vitals (LCP/CLS/INP) на smoke-наборе страниц.

### 2) SEO
- **Плюсы:**
  - Есть централизованные `metadata` в `app/layout.tsx`.
  - Реализованы динамические `sitemap` и `robots.txt`.
- **Сделано в этом цикле:**
  - Базовый URL для canonical/metadata переведён на единый источник `getPublicBaseUrl()`, чтобы убрать расхождения между окружениями.
  - Добавлены явные `robots`/`googleBot` directives в metadata (`index/follow`, расширенные preview snippets).
- **Рекомендации:**
  1. Для карточек товара и постов добавить расширенную OG-разметку с изображением и типом контента.
  2. Проверить уникальность `title/description` у листингов с фильтрами (бренды, пагинация).

### 3) Доступность (Accessibility)
- **Плюсы:**
  - Есть `aria-label` на части интерактивных элементов (кнопки корзины/избранного, ссылки).
  - В базовых страницах есть семантические заголовки `h1`.
- **Риски:**
  - Часть изображений пока на `<img>` (может ухудшать совместимость с адаптивной загрузкой и контроль атрибутов).
  - Для некоторых UI-паттернов стоит проверить видимые состояния фокуса и контрастность после брендовых кастомизаций.
- **Рекомендации:**
  1. Прогнать автоматическую проверку axe/Lighthouse по основным страницам (`/`, `/shop`, `/blog/[slug]`, `/checkout`).
  2. Добавить регрессионный чек WCAG-контрастов в дизайн-системе.

### 4) Обработка поисковиками (crawl/index)
- **Плюсы:**
  - `robots.txt` указывает `Sitemap` и закрывает `/admin` и `/api`.
  - `sitemap` включает статические, товарные, блоговые и брендовые URL.
- **Риски/наблюдения:**
  - Брендовые URL в sitemap представлены query-страницами (`/shop?brand=...`). Для ряда роботов URL с параметрами хуже предсказуемы, чем человекочитаемые маршруты.
- **Рекомендации:**
  1. Рассмотреть выделенные SEO-friendly маршруты брендов (например, `/shop/brand/[slug]`) и включить их в sitemap.
  2. Контролировать индексацию фильтров и дублей (canonical на параметризованных страницах).

### Проверки, выполненные в рамках анализа
- `npx tsc --noEmit` — успешно.
- `npm run build` — не выполнен из-за отсутствия `DATABASE_URL` в окружении (ожидаемое ограничение текущего пайплайна).
